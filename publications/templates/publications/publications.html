{% load sekizai_tags %}
{% load cms_tags %}
<head>
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>

{% addtoblock "js" %}
    <script defer>
        // good codepen for reference in the loading portion:
        // https://codepen.io/BackyardCoder/pen/vZjpEV
        function getCSRFToken() {
            // Attempt to retrieve the CSRF token from the meta tag
            const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            return token;
        }        
        const url = '/publications/publications-api/';

        // Define the data you want to send. Example data shown here:
        const requestData = {
            api_key: "{{ instance.api_key | safe }}",
            library_id: "{{ instance.library_id | safe }}",
            library_type: "{{ instance.library_type | safe }}",
            collection_id: "{{ instance.collection_id | safe }}",
        };
    
        function fetchPublications() {
            // Assuming your Django server is running on localhost:8000
            // Update the URL if your setup is different or if you are using a production server
            fetch(url, {
                method: 'POST', // or 'GET' if you're sending data in query params
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(), // Include the CSRF token in the request headers
                },
                body: JSON.stringify(requestData),
            })
              .then(response => {
                document.getElementById('placeholder-publications').classList.add('hidden'); // Hide spinner
                document.getElementById('publications-html').classList.remove('hidden'); // Show content


                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json(); // Assuming the response is JSON
              })
              .then(data => {
                let publicationsHTML = ``
                for (const [key, value] of Object.entries(data)) {
                    //add the year title 
                    publicationsHTML += `<h2 class="year-style">${key}</h2>`
                    //add the publications
                    value.forEach((publication) => {
                        publicationsHTML += publication
                    })
                }
                document.getElementById('publications-html').innerHTML = publicationsHTML;

                // For example, you could iterate over the data and append it to an element in your HTML
              })
              .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
              });
          }
        const create_placeholders = () => {
            let placeholdersHtmlElement = document.getElementById('placeholder-publications');
            let htmlPlaceholders = '';
            for(var i = 0; i < 10; i++){
                htmlPlaceholders+=`<h2 class="year-style loading" style="background: #cbcbcb; height:50px;"></h2><div class="csl-bib-body loading" style="line-height: 2; padding-left: 1em; text-indent:-1em;">`
                for(var j = 0; j < 5; j++){
                    htmlPlaceholders+= `<div class="csl-entry loading" style="background: #e3e3e3;height: 70px; margin-bottom:10px !important;"><i></i></div>`   
                }
                htmlPlaceholders+=`</div>`
            }
            placeholdersHtmlElement.innerHTML = htmlPlaceholders;            
        }
        
        create_placeholders()
        fetchPublications();
    </script>

{% endaddtoblock %}

{% addtoblock "css" %}
<style>
    
    @import url('https://fonts.googleapis.com/css?family=Open+Sans&display=swap');
    @import url('https://fonts.googleapis.com/css?family=Raleway:300,400,700&display=swap');
    @import url('https://fonts.googleapis.com/css?family=Roboto:300,400,700&display=swap');
    
    
    .container-zotero-plugin{
        display: none;
    }
    
    .csl-entry {
        word-wrap: break-word;
        margin: 0 !important;
    }
    .csl-entry,
    .csl-entry * {
        box-sizing: content-box;
    }
    .csl-bib-body{
        line-height: 2; 
        padding-left: 1em; 
        text-indent:-1.5em !important;
        padding-bottom:0.5em;
    }
    .wrapper-publication-set{
        color: #1c1e21;
        font-size: 16px;
    }
    .year-style{
        padding-top: 1rem;
    }

    .hidden {
        display: none;
    }


    .loading{
        animation: hintloading 1.5s ease-in-out 0s infinite reverse;
        -webkit-animation: hintloading 1.5s ease-in-out 0s infinite reverse;
      }
      
      @keyframes hintloading
      {
        0% {
          opacity: 0.8;
        }
        50%  {
          opacity: 1;
        }
        100% {
          opacity: 0.8;
        }
      }
      
      @-webkit-keyframes hintloading
      {
        0% {
          opacity: 0.8;
        }
        50%  {
          opacity: 1;
        }
        100% {
          opacity: 0.8;
        }
      }
      
</style>
{% endaddtoblock %}

{% block content %}

    <div id="placeholder-publications"></div>
    <div id="publications-html" class="wrapper-publication-set hidden">


</div>
{% endblock %}
